<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">

<head th:replace="~{fragments/head :: head('Tasks')}"></head>

<body>

    <!-- Header -->
    <div th:replace="~{fragments/header :: header}"></div>

    <div th:replace="~{fragments/messages :: messages}"></div>

    <!-- Content -->
    <div class="container mx-auto p-4 flex flex-col gap-4 justify-start items-start overflow-y-scroll">

        <!-- Desktop Header -->
        <div class="hidden md:flex flex-row justify-end items-center w-full gap-4">
            <!-- Add Task Modal-->
            <div x-data="{ openModal: false }">
                <button @click="openModal = true"
                    class="flex font-bold gap-2 items-center bg-blue-500 hover:bg-blue-600 text-white py-3 px-4 shadow-lg">
                    <img th:src="@{/img/plus.svg}" alt="+" class="w-8 h-8">
                    New Task
                </button>

                <div x-show="openModal" x-transition
                    class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">

                    <div class="bg-white p-6 rounded-lg shadow-lg w-96" @click.away="openModal = false">

                        <h2 class="text-xl font-bold mb-4 text-blue-600">Add Task</h2>

                        <!-- Forms -->
                        <form th:action="@{/tasks}" method="post">
                            <div class="mb-3">
                                <label class="block text-gray-700 mb-1">Title</label>
                                <input type="text" name="title" class="w-full border border-gray-300 rounded p-2" required>
                            </div>

                            <div class="mb-3">
                                <label class="block text-gray-700 mb-1">Description</label>
                                <textarea name="description" class="w-full border border-gray-300 rounded p-2"></textarea>
                            </div>

                            <input type="hidden" name="status" th:value="PENDING">

                            <div class="mb-3">
                                <label class="block text-gray-700 mb-1">Priority</label>
                                <select name="priority" class="w-full border border-gray-300 rounded p-2 outline-blue-500">
                                    <option th:each="priority : ${priorities}" th:value="${priority}" th:text="${priority}">
                                        Priority</option>
                                </select>
                            </div>

                            <div class="flex justify-end gap-3 mt-4">
                                <button type="button" @click="openModal = false"
                                    class="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400">
                                    Cancelar
                                </button>

                                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-500">
                                    Salvar
                                </button>
                            </div>
                        </form>

                    </div>
                </div>
            </div>
            <!-- Filter -->
            <div x-data="{ openFilterModal: false }">
                <button @click="openFilterModal = true"
                    class="flex font-bold gap-2 items-center bg-blue-500 hover:bg-blue-600 text-white py-3 px-4 shadow-lg">
                    <img th:src="@{/img/filter.svg}" alt="Filter" class="w-8 h-8">
                    Filter
                </button>

                <div x-show="openFilterModal" x-transition
                    class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">

                    <div class="bg-white p-6 rounded-lg shadow-lg w-96" @click.away="openFilterModal = false">

                        <h2 class="text-xl font-bold mb-4 text-blue-600">Filter Tasks</h2>

                        <!-- Forms -->
                        <form th:action="@{/tasks/filter}" method="get" class="space-y-4">
                            <div>
                                <label class="block text-gray-700 mb-1">Status</label>
                                <select name="status" class="w-full border border-gray-300 rounded p-2">
                                    <option value="" th:selected="${selectedStatus == null or selectedStatus == ''}">All</option>
                                    <option th:each="status : ${TaskStatus.values()}"
                                            th:value="${status}"
                                            th:text="${status}"
                                            th:selected="${selectedStatus == status.name()}">
                                    </option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-1">Priority</label>
                                <select name="priority" class="w-full border border-gray-300 rounded p-2 outline-blue-500">
                                    <option value="" th:selected="${selectedPriority == null or selectedPriority == ''}">All</option>
                                    <option th:each="priority : ${priorities}"
                                            th:value="${priority}"
                                            th:text="${priority}"
                                            th:selected="${selectedPriority == priority.name()}">
                                    </option>
                                </select>
                            </div>
                            <div class="w-full flex items-center justify-end">
                                <a th:href="@{/tasks}" th:if="${selectedStatus != null or selectedPriority != null}" class="text-blue-600 hover:underline">Clear Filter</a>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">
                                Apply Filter
                            </button>
                        </form>

                    </div>
                </div>

            </div>


        </div>

        <!-- Tasks-->
        <h1 th:if="${userTasks == null or userTasks.size() == 0}"
            class="w-full mt-5 p-2 text-2xl text-left font-bold text-blue-600 border-b border-blue-600">No Pending tasks
            found
        </h1>

        <!-- Pending Tasks-->
        <ul th:if="${userTasks != null and userTasks.size() > 0}" class="w-full">
            <h1 class="text-2xl font-bold text-blue-600 border-b border-blue-600">Pending Tasks</h1>
            <li th:each="task : ${userTasks}" th:if="${task.status == TaskStatus.PENDING}"
                class="flex flex-row gap-4 items-center bg-white rounded p-3 shadow">

                <form th:action="@{/tasks/{id}/status(id=${task.id})}" method="post" th:object="${task}">
                    <input type="hidden" name="status"
                        th:value="${task.status == TaskStatus.COMPLETED ? 'PENDING' : 'COMPLETED'}" />

                    <input type="checkbox" th:checked="${task.status == TaskStatus.COMPLETED}"
                        onchange="this.form.submit()" />
                </form>

                <div class="w-full flex justify-between items-center">
                    <!-- Task info -->
                    <div class="flex flex-col w-40">
                        <h2 class="text-lg font-bold" th:text="${'Title: ' + task.title}"></h2>
                        <p class="text-gray-600 flex-wrap" th:if="${task.description != ''}"
                            th:text="${'Description: ' + task.description}"></p>
                        <p class="text-gray-600" th:text="${'Priority: ' + task.priority}"></p>
                    </div>

                    <!-- Buttons -->
                    <div th:replace="~{fragments/action-buttons :: action-buttons(${task.id})}"></div>
                </div>

            </li>
        </ul>

        <!-- Completed Tasks-->
        <ul th:if="${userTasks != null and userTasks.size() > 0}" class="w-full bg-white rounded p-2">
            <h1 class="text-2xl font-bold text-blue-600 border-b border-blue-600">
                Completed Tasks</h1>
            <li th:each="task : ${userTasks}" th:if="${task.status == TaskStatus.COMPLETED}"
                class="flex flex-row gap-4 items-center bg-white rounded p-3 shadow">

                <form th:action="@{/tasks/{id}/status(id=${task.id})}" method="post" th:object="${task}">
                    <input type="hidden" name="status"
                        th:value="${task.status == TaskStatus.COMPLETED ? 'PENDING' : 'COMPLETED'}" />

                    <input type="checkbox" th:checked="${task.status == TaskStatus.COMPLETED}"
                        onchange="this.form.submit()" />
                </form>

                <div class="w-full flex justify-between items-center">
                    <!-- Task info -->
                    <div class="flex flex-col w-40 gap-2">
                        <h2 class="text-lg font-bold" th:text="${'Title: ' + task.title}"></h2>
                        <p class="text-gray-600 flex-wrap" th:if="${task.description != ''}"
                            th:text="${'Description: ' + task.description}"></p>
                        <p class="text-gray-600" th:text="${'Priority: ' + task.priority}"></p>
                        <p class="flex">
                            <img th:src="@{/img/check.svg}" class="w-6 h-6" alt="Completed at:">
                            <span th:text="${#temporals.format(task.completedAt, 'yyyy/MM/dd HH:mm')}"></span>
                        </p>
                    </div>
                    <!-- Buttons -->
                    <div th:replace="~{fragments/action-buttons :: action-buttons(${task.id})}"></div>
                </div>

            </li>
        </ul>

    </div>

    <!-- Floating Button and Filter Modal -->
    <div x-data="{ openFilterModal: false }" class="fixed bottom-20 right-4 lg:hidden">
        <button @click="openFilterModal = true"
            class="bg-blue-500 hover:bg-blue-600 text-white rounded-full py-3 px-4 shadow-lg">
            <img th:src="@{/img/filter.svg}" alt="Filter" class="w-8 h-8">
        </button>

        <div x-show="openFilterModal" x-transition
            class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">

            <div class="bg-white p-6 rounded-lg shadow-lg w-96" @click.away="openFilterModal = false">

                <h2 class="text-xl font-bold mb-4 text-blue-600">Filter Tasks</h2>

                <!-- Forms -->
                <form th:action="@{/tasks/filter}" method="get" class="space-y-4">
                    <div>
                        <label class="block text-gray-700 mb-1">Status</label>
                        <select name="status" class="w-full border border-gray-300 rounded p-2">
                            <option value="" th:selected="${selectedStatus == null or selectedStatus == ''}">All</option>
                            <option th:each="status : ${TaskStatus.values()}"
                                    th:value="${status}"
                                    th:text="${status}"
                                    th:selected="${selectedStatus == status.name()}">
                            </option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1">Priority</label>
                        <select name="priority" class="w-full border border-gray-300 rounded p-2 outline-blue-500">
                            <option value="" th:selected="${selectedPriority == null or selectedPriority == ''}">All</option>
                            <option th:each="priority : ${priorities}"
                                    th:value="${priority}"
                                    th:text="${priority}"
                                    th:selected="${selectedPriority == priority.name()}">
                            </option>
                        </select>
                    </div>
                    <div class="w-full flex items-center justify-end">
                        <a th:href="@{/tasks}" th:if="${selectedStatus != null or selectedPriority != null}" class="text-blue-600 hover:underline">Clear Filter</a>
                    </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">
                        Apply Filter
                    </button>
                </form>

            </div>
        </div>

    </div>

    <!-- Floating Button and Modal-->
    <div x-data="{ openModal: false }" class="fixed bottom-4 right-4 lg:hidden">
        <button @click="openModal = true"
            class="bg-blue-500 hover:bg-blue-600 text-white rounded-full py-3 px-4 shadow-lg">
            <img th:src="@{/img/plus.svg}" alt="+" class="w-8 h-8">
        </button>

        <div x-show="openModal" x-transition
            class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">

            <div class="bg-white p-6 rounded-lg shadow-lg w-96" @click.away="openModal = false">

                <h2 class="text-xl font-bold mb-4 text-blue-600">Add Task</h2>

                <!-- Forms -->
                <form th:action="@{/tasks}" method="post">
                    <div class="mb-3">
                        <label class="block text-gray-700 mb-1">Title</label>
                        <input type="text" name="title" class="w-full border border-gray-300 rounded p-2" required>
                    </div>

                    <div class="mb-3">
                        <label class="block text-gray-700 mb-1">Description</label>
                        <textarea name="description" class="w-full border border-gray-300 rounded p-2"></textarea>
                    </div>

                    <input type="hidden" name="status" th:value="PENDING">

                    <div class="mb-3">
                        <label class="block text-gray-700 mb-1">Priority</label>
                        <select name="priority" class="w-full border border-gray-300 rounded p-2 outline-blue-500">
                            <option th:each="priority : ${priorities}" th:value="${priority}" th:text="${priority}">
                                Priority</option>
                        </select>
                    </div>

                    <div class="flex justify-end gap-3 mt-4">
                        <button type="button" @click="openModal = false"
                            class="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400">
                            Cancelar
                        </button>

                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-500">
                            Salvar
                        </button>
                    </div>
                </form>

            </div>
        </div>

    </div>
</body>

</html>